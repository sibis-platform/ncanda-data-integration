#!/bin/bash -l 
cur_dir=`dirname $0`
config="/fs/storage/share/operations/secrets/.sibis/.sibis-general-config.yml"
backup_src=/fs/storage/mariadb-redcap-archive
backup_lock=/fs/storage/ncanda_redcap_backup.lock
retain_local_copy=${1:-1}
backup_src_spec="${backup_src}/*.sql.gz"

## Load common utils
source $cur_dir/transmit_utils

if [[ -e "$backup_lock" ]]; then
  printf 'Lockfile: %s exists, aborting.\n' "$backup_lock"
  exit 0
else
  printf '%s\n%s\n' "$START_TIME" "$$" > $backup_lock
fi

function remove_lock() {
  rm -rf $backup_lock
  exit 0
}

trap "remove_lock" EXIT

archive_file=$(ls -t ${backup_src_spec} | head -n 1)
if [[ -z "$archive_file" ]]; then
  printf 'ERROR: Backup date could not be determined. Date not detected in %s' "$date_file"
  exit 1
fi

upload_to_s3 $archive_file ${retain_local_copy}
